/*
 * servo.c
 *
 *  Created on: 2023年3月24日
 *      Author: 开心就好
 */
#include "servo/servo.h"


//定义舵机运动矫正结构体参数
ServoStruct servoStr;


//-------------------------------------------------------------------------------------------------------------------
// 函数简介     舵机初始化
// 参数说明     void
// 返回参数     void
//-------------------------------------------------------------------------------------------------------------------
void servo_init(void)
{
    //舵机初始化
    pwm_init(servo_pwm_out_pin, 50, (uint32)(medium_point * TO_PENCENT));    //占空比在0~10000.
    //初始时，舵机在中点位置
    pwm_set_duty(servo_pwm_out_pin, (uint32)(medium_point * TO_PENCENT));
}


//-------------------------------------------------------------------------------------------------------------------
// 函数简介     角度转换为pwm
// 参数说明     float     angle(-MAX_ANGLE ~ MAX_ANGLE)
// 返回参数     int16_t
//-------------------------------------------------------------------------------------------------------------------
static int16_t servo_angel_to_pwm(float angle)
{
    //定义静态变量进行存储pwm值
    static float servo_pwm_in = 0;
    static float servo_pwm_out = 0;

    //由于车身限制的物理角度限幅
    if(angle >= MAX_ANGLE)
    {
        angle = MAX_ANGLE;
    }
    else if(angle <= -MAX_ANGLE)
    {
        angle = -MAX_ANGLE;
    }

    //将角度换算为对应的pwm-90°~90°对应-1000~1000
    servo_pwm_in = angle * translate_angle_to_pwm;
    //pwm偏移到500~2500
    servo_pwm_out = (float)medium_point + servo_pwm_in;
    //变量转换为int型
    int16_t servo_pwm_out_int = (int16_t)servo_pwm_out;

    //返回转换的pwm值
    return servo_pwm_out_int;
}


//-------------------------------------------------------------------------------------------------------------------
// 函数简介     舵机控制
// 参数说明     float     angle(-MAX_ANGLE ~ MAX_ANGLE)
// 返回参数     void
//-------------------------------------------------------------------------------------------------------------------
void servo_contral(float angle)
{
    //定义存储变量
    static int16_t pwm_out;
    //舵机角度转换
    pwm_out = servo_angel_to_pwm(angle);

    //舵机输出pwm限幅
    if(pwm_out >= RIGHT_PWM_MAX)
    {
        pwm_out = RIGHT_PWM_MAX;
    }
    else if(pwm_out <= LEFT_PWM_MAX)
    {
        pwm_out = LEFT_PWM_MAX;
    }

    //输出pwm控制角度
    pwm_set_duty(servo_pwm_out_pin, (uint32)(pwm_out * TO_PENCENT));
}


/**
* @brief        舵机输出PWM设置（矫正后）
* @param        pwm：500~2500
* @ref
* @author       Leo
* @note
**/
//-------------------------------------------------------------------------------------------------------------------
// 函数简介     舵机输出PWM设置（结合上位机进行矫正）
// 参数说明     float     pwm：500~2500
// 返回参数     void
//-------------------------------------------------------------------------------------------------------------------
uint16_t pwm_Servo = 0;
void SERVO_SetPwmValueCorrect(uint16 pwm)
{
    pwm = 3000 - pwm;  //左→右

    pwm -= servoStr.thresholdMiddle-SERVO_PWM_MIDDLE; //中值补偿

    uint16_t pwmMax = 3000 - servoStr.thresholdLeft;
    uint16_t pwmMin = 3000 - servoStr.thresholdRight;
    if(pwm < pwmMin)
        pwm = pwmMin;
    else if(pwm > pwmMax)
        pwm = pwmMax;

    pwm_Servo = pwm;
    TIM_SetCompare1(TIM4,pwm);
}
